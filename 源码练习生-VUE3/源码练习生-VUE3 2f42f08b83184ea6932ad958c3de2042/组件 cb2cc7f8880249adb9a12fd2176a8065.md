# ç»„ä»¶

æˆ‘ä»¬åœ¨é¢è¯•ä¸­ï¼Œç»å¸¸ä¼šè¢«é—®åˆ°keep-aliveï¼Œcomponentï¼Œtransitionç­‰ç­‰å†…ç½®ç»„ä»¶çš„ä½œç”¨ç”šè‡³æ˜¯åŸç†ï¼Œé‚£ä¹ˆæœ¬ç¯‡å°±å¸¦å¤§å®¶æ·±å…¥äº†è§£ä¸€ä¸‹ç»„ä»¶çš„æ¦‚å¿µä»¥åŠåœ¨æºç ä¸­æ˜¯å¦‚ä½•è¢«å¤„ç†çš„ï¼ŒåŒæ ·ï¼Œæœ¬ç¯‡çš„ä»£ç è¿˜æ˜¯åœ¨runtime-coreä¸­

> å®ƒå’Œrendereræ¯æ¯ç›¸å…³ï¼Œä¸ºäº†åˆ†ç¦»å†…å®¹ï¼Œæˆ‘ä»¬å°†ç©¿æ’å°‘é‡rendererçš„ä»£ç ï¼Œä½†æ˜¯ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬åœ¨componentså’Œrendereråˆ†ææ–‡ç« ä¸­ï¼Œåšäº†å¤§é‡çš„æç¤ºï¼Œæ–¹ä¾¿è¯»è€…å¯ä»¥æ¥å›ç©¿æ’é˜…è¯»ã€‚
> 

é¦–å…ˆï¼Œæœ¬ç¯‡æ–‡ç« è¦ä»¥ä¸€ä¸ªâ€œç»„ä»¶â€çš„æ¦‚å¿µå¼€å§‹ã€‚æˆ‘ä»¬ä»rendererå¼€å§‹å°±å¼€å§‹æ‰§è¡ŒcreateComponentInstanceï¼ˆåˆ›å»ºç»„ä»¶å®ä¾‹ï¼‰çš„å·¥ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä»è¿™ä¸ªå‡½æ•°æ¥åˆ‡å…¥ï¼

```tsx
// runtime-core/renderer.ts
const mountComponent: MountComponentFn = (
	...çœç•¥å¾ˆå¤šå‚æ•°
) => {
	// å‰é¢æœ‰ä¸€æ®µå…¼å®¹æ€§ä»£ç ï¼ŒæŒ‡çš„æ˜¯vue2.xæ˜¯å¯ä»¥åœ¨mountå‰å®ä¾‹åŒ–ç»„ä»¶çš„
	// ä½†æ˜¯æˆ‘ä»¬æ­¤æ—¶åªè®¨è®ºvue3çš„æƒ…å†µï¼Œå¦‚æœæ˜¯vue3ï¼ŒcompatMountInstanceå°†æ˜¯nullï¼Œä¼šèµ°createComponentInstanceè¿™ä¸ªå‡½æ•°
	// ...
	const instance: ComponentInternalInstance =
    compatMountInstance ||
    (initialVNode.component = createComponentInstance(
      initialVNode,
      parentComponent,
      parentSuspense
    ))
	// ...
}
```

æˆ‘ä»¬æ¥çœ‹çœ‹createComponentInstanceçš„æ ¸å¿ƒé€»è¾‘

```tsx
export function createComponentInstance(
  vnode: VNode,
  parent: ComponentInternalInstance | null,
  suspense: SuspenseBoundary | null
) {
	
  const type = vnode.type as ConcreteComponent
  // inherit parent app context - or - if root, adopt from root vnode
  const appContext =
    (parent ? parent.appContext : vnode.appContext) || emptyAppContext
	
	// æ„å»ºç»„ä»¶å®ä¾‹
  const instance: ComponentInternalInstance = {
    uid: uid++, // uidæ˜¯ä»0å¼€å§‹çš„
    vnode,
    type,
    parent,
    appContext,
    root: null!, // to be immediately set
    next: null,
    subTree: null!, // will be set synchronously right after creation
    update: null!, // will be set synchronously right after creation
    scope: new EffectScope(true /* detached */),
    render: null,
    proxy: null,
    exposed: null,
    exposeProxy: null,
    withProxy: null,
    provides: parent ? parent.provides : Object.create(appContext.provides),
    accessCache: null!,
    renderCache: [],

    // local resovled assets
    components: null,
    directives: null,

    // resolved props and emits options
    propsOptions: normalizePropsOptions(type, appContext),
    emitsOptions: normalizeEmitsOptions(type, appContext),

    // emit
    emit: null!, // to be set immediately
    emitted: null,

    // props default value
    propsDefaults: EMPTY_OBJ,

    // inheritAttrs
    inheritAttrs: type.inheritAttrs,

    // state
    ctx: EMPTY_OBJ,
    data: EMPTY_OBJ,
    props: EMPTY_OBJ,
    attrs: EMPTY_OBJ,
    slots: EMPTY_OBJ,
    refs: EMPTY_OBJ,
    setupState: EMPTY_OBJ,
    setupContext: null,

    // suspense related
    suspense,
    suspenseId: suspense ? suspense.pendingId : 0,
    asyncDep: null,
    asyncResolved: false,

    // lifecycle hooks
    // not using enums here because it results in computed properties
    isMounted: false,
    isUnmounted: false,
    isDeactivated: false,
    bc: null,
    c: null,
    bm: null,
    m: null,
    bu: null,
    u: null,
    um: null,
    bum: null,
    da: null,
    a: null,
    rtg: null,
    rtc: null,
    ec: null,
    sp: null
  }
  if (__DEV__) {
		// å¦‚æœæ˜¯devæ¨¡å¼ï¼Œå°±åˆ›å»ºå¼€å‘äººå‘˜çš„ä¸Šä¸‹æ–‡
		// ä¸ºä»€ä¹ˆè¿™é‡Œè¦å•ç‹¬åˆ›å»ºä¸€ä¸‹å¼€å‘è€…ä¸Šä¸‹æ–‡ï¼Œè‡ªç„¶æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•
		// åœ¨è¿™ä¸ªå‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æµè§ˆå™¨æ§åˆ¶å°è°ƒå‡ºå®ä¾‹çš„å±æ€§ï¼Œä¹Ÿå¯ä»¥è°ƒå‡ºå…¬å¼€å±æ€§
		// è¿™ä¸ªä¸æ˜¯å¾ˆé‡è¦ ğŸ˜„
    instance.ctx = createDevRenderContext(instance)
  } else {
		// å¦‚æœæ˜¯ç”Ÿäº§ï¼Œç›´æ¥æŠŠå®ä¾‹èµ‹å€¼äº†
    instance.ctx = { _: instance }
  }
  instance.root = parent ? parent.root : instance
  instance.emit = emit.bind(null, instance)
	 // ...
	// è¿”å›å®ä¾‹ï¼Œåˆ›å»ºå®Œæ¯•
  return instance
}
```

okï¼Œå°±è¿™æ ·æˆ‘ä»¬å°±æ‹¥æœ‰äº†ä¸€ä¸ªç»„ä»¶çš„å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªä¾‹ä¸Šåšä¸€äº›å¥½ç©çš„äº‹æƒ…ï¼Œæ¯”å¦‚è®¾ç½®ç»„ä»¶...

æˆ‘ä»¬å¯ä»¥åœ¨component.tsä¸­æ‰¾åˆ°è¿™æ ·çš„æ ¸å¿ƒå‡½æ•°

```tsx
export function setupComponent(
  instance: ComponentInternalInstance,
  isSSR = false
) {
	// 
  isInSSRComponentSetup = isSSR
	
  const { props, children } = instance.vnode
	// åˆ¤æ–­æ˜¯å¦æ˜¯â€œæœ‰çŠ¶æ€â€çš„ç»„ä»¶ï¼Œä¸‹é¢çš„å‡½æ•°ä¼šæ ¹æ®æ˜¯å¦æœ‰çŠ¶æ€åšä¸åŒçš„é€»è¾‘
  const isStateful = isStatefulComponent(instance)
	// è¿è¡Œåˆå§‹åŒ–propså’Œæ’æ§½çš„å·¥ä½œ
  initProps(instance, props, isStateful, isSSR)
  initSlots(instance, children)
	
	// åœ¨ä¸€å®šæƒ…å†µä¸‹ï¼Œä¼šè°ƒç”¨â€œè®¾ç½®æœ‰çŠ¶æ€ç»„ä»¶â€çš„å‡½æ•°
  const setupResult = isStateful
    ? setupStatefulComponent(instance, isSSR)
    : undefined
  isInSSRComponentSetup = false
  return setupResult
}
```

éœè¿˜æœ‰ä¸€ä¸ªä¸“é—¨è®¾ç½®æœ‰çŠ¶æ€ç»„ä»¶çš„å‡½æ•°ï¼ˆsetupStatefulComponentï¼‰ğŸ¶Â ï¼Œ æˆ‘ä»¬å¯ä»¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆ

å‰ç½®é˜…è¯»ï¼ˆå®˜ç½‘æ–‡æ¡£ï¼‰

[å†…ç½®ç»„ä»¶ | Vue.js](https://v3.cn.vuejs.org/api/built-in-components.html#component)

## keep-alive

> `<keep-alive>`Â åŒ…è£¹åŠ¨æ€ç»„ä»¶æ—¶ï¼Œä¼šç¼“å­˜ä¸æ´»åŠ¨çš„ç»„ä»¶å®ä¾‹ï¼Œè€Œä¸æ˜¯é”€æ¯å®ƒä»¬
> 

åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨è¿™ä¸ªæŠ½è±¡ç»„ä»¶å¯¹åº”ç”¨è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œåœ¨ä»¥å‰æˆ‘ç‰¹åˆ«å–œæ¬¢æŠŠkeep-aliveåŒ…è£¹æ•´ä¸ªapp.vueï¼›ä½†æ˜¯keep-aliveæœ€å¥½è¦åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨çš„ï¼Œæ¯”å¦‚ç®€å•ä¸¾ä¸ªä¾‹å­ï¼š

1. ä¸€ä¸ªé¡µé¢ä¸‹åŒ…å«ä¸€ä¸ªtabå’Œå¤šä¸ªå†…å®¹å±•ç¤ºç»„ä»¶ï¼Œåˆ‡æ¢tabçš„æ—¶å€™å¯¹åº”çš„å†…å®¹ç»„ä»¶ä¹Ÿä¼šè¢«åˆ‡æ¢ã€‚è€Œåœ¨è¿™æ ·çš„åœºæ™¯ä¸­ï¼Œæˆ‘çš„å†…å®¹ç»„ä»¶ä¸éœ€è¦æ¯æ¬¡éƒ½è¦è°ƒç”¨mountedè·å–æ•°æ®ï¼Œå¦‚æœä½¿ç”¨keep-aliveåŒ…è£¹ä½æ­¤é¡µé¢ï¼Œé‚£ä¹ˆä¸ä»…æˆ‘çš„æ•°æ®èƒ½å¤Ÿè¢«æŒä¹…åŒ–è¿˜ä¸ä¼šé‡å¤æŒ‚è½½ã€‚

okï¼Œæˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹æºç ï¼Œæ ¸å¿ƒå‡½æ•°è‚¯å®šå°±æ˜¯KeepAliveImplï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆç»„ä»¶å¯¹è±¡ï¼‰ï¼Œåœ¨è¿™ä¸ªç»„ä»¶å®ç°ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å’Œæˆ‘ä»¬æ—¥å¸¸å¼€å‘çš„ç»„ä»¶ä¸€æ¨¡ä¸€æ ·

```tsx
// runtime-core/components/KeepAlive.ts
const KeepAliveImpl: ComponentOptions = {
  name: `KeepAlive`,

  // Marker for special handling inside the renderer. We are not using a ===
  // check directly on KeepAlive in the renderer, because importing it directly
  // would prevent it from being tree-shaken.
  __isKeepAlive: true,
	// å®šä¹‰æˆ‘ä»¬ç†Ÿæ‚‰çš„propsï¼Œå…·ä½“å«ä¹‰çœ‹keyéƒ½èƒ½æ˜ç™½å“ˆğŸ˜„
  props: {
    include: [String, RegExp, Array],
    exclude: [String, RegExp, Array],
    max: [String, Number]
  },

  setup(props: KeepAliveProps, { slots }: SetupContext) {
    const instance = getCurrentInstance()!
    // KeepAlive communicates with the instantiated renderer via the
    // ctx where the renderer passes in its internals,
    // and the KeepAlive instance exposes activate/deactivate implementations.
    // The whole point of this is to avoid importing KeepAlive directly in the
    // renderer to facilitate tree-shaking.
		// è¿™é‡Œé€šè¿‡ç»™æ¸²æŸ“å™¨ä¼ é€’ctxä¸Šä¸‹æ–‡ç”¨æ¥å®ç°activatedè¯¸å¦‚æ­¤ç±»çš„æ–¹æ³•å®ç°ï¼Œä¸‹é¢å¾ˆå¤šæ“ä½œéƒ½æ˜¯ç›´æ¥æŒ‚åœ¨sharedContextçš„
    const sharedContext = instance.ctx as KeepAliveContext

    // if the internal renderer is not registered, it indicates that this is server-side rendering,
    // for KeepAlive, we just need to render its children
		// åˆ¤æ–­å¦‚æœæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå°±ä»…ä»…æ¸²æŸ“å®ƒçš„å­ç»„ä»¶ï¼ˆæ’æ§½defaultï¼‰
		// è¿™é‡Œçš„å®ç°ç»†èŠ‚æˆ‘ä»¬ä¸éœ€è¦å¤ªå…³å¿ƒï¼Œå› ä¸ºè¿™æ˜¯ç»†ææœ«èŠ‚çš„ä¸œè¥¿
    if (!sharedContext.renderer) {
      return slots.default
    }

    const cache: Cache = new Map()
    const keys: Keys = new Set()
    let current: VNode | null = null

    if (__DEV__ || __FEATURE_PROD_DEVTOOLS__) {
      ;(instance as any).__v_cache = cache
    }

    const parentSuspense = instance.suspense
		
		// ä»ä¸Šä¸‹æ–‡è§£æ„å‡ºè¿™ä¹ˆä¸ªç©æ„ï¼Œè¿™ä¸ªsharedContextåˆ°åº•æ˜¯ä½•æ–¹ç¥åœ£ï¼Œæˆ‘ä»¬ä¸€ä¼šå†çœ‹çœ‹
		// patch, move, unmount, createElement ä»è¿™äº›å•è¯æˆ‘ä»¬éƒ½èƒ½å¤§æ¦‚ç†è§£ä»€ä¹ˆæ„æ€...
    const {
      renderer: {
        p: patch,
        m: move,
        um: _unmount,
        o: { createElement }
      }
    } = sharedContext
		// ...
}
```

å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨ keepalive ä¸­æˆ‘ä»¬ä¸€å¼€å§‹å°±é‡åˆ°äº†ä¸€äº›ä»æ¥æ²¡æœ‰è§è¿‡çš„é—®é¢˜ï¼Œè¿™ä¸€åˆ‡éƒ½è¦ä»getCurrentInstanceè¿™ä¸ªå‡½æ•°è¯´èµ·ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯æ€ä¹ˆè·å–å½“å‰å®ä¾‹çš„ã€‚

```tsx
// runtime-core/component.ts
// åœ¨getæ–¹æ³•ä¸­ï¼Œè¦ä¹ˆè¿”å›å½“å‰å®ä¾‹ï¼Œè¦ä¹ˆè¿”å›å½“å‰æ¸²æŸ“å®ä¾‹
export const getCurrentInstance: () => ComponentInternalInstance | null = () =>
  currentInstance || currentRenderingInstance
```

æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦‚ä½•è®¾ç½®å®ä¾‹çš„ï¼Œå°±æ˜¯setæ–¹æ³•äº†

```tsx
export const setCurrentInstance = (instance: ComponentInternalInstance) => {
  currentInstance = instance
  instance.scope.on()
}
```

æˆ‘ä»¬çœ‹çœ‹setupStatefulComponentæ˜¯æ€ä¹ˆè®¾ç½®æœ‰çŠ¶æ€çš„ç»„ä»¶çš„

```tsx
function setupStatefulComponent(
  instance: ComponentInternalInstance,
  isSSR: boolean
) {
  const Component = instance.type as ComponentOptions

  if (__DEV__) {
		// åœ¨devç¯å¢ƒä¸‹å¯¹éƒ¨åˆ†ç‰¹æ€§ï¼ˆåç§°ï¼Œå­ç»„ä»¶ï¼ŒæŒ‡ä»¤ï¼‰åšæ£€æµ‹
    if (Component.name) {
			// ä¸è¦å°†htmlå†…ç½®çš„å…ƒç´ åç§°ä½œä¸ºç»„ä»¶å
      validateComponentName(Component.name, instance.appContext.config)
    }
    if (Component.components) {
      const names = Object.keys(Component.components)
      for (let i = 0; i < names.length; i++) {
				// ä¸è¦å°†htmlå†…ç½®çš„å…ƒç´ åç§°ä½œä¸ºç»„ä»¶å
        validateComponentName(names[i], instance.appContext.config)
      }
    }
    if (Component.directives) {
      const names = Object.keys(Component.directives)
      for (let i = 0; i < names.length; i++) {
				// ä¸è¦å°†vueå†…ç½®çš„æŒ‡ä»¤åç§°ä½œä¸ºè‡ªå®šä¹‰æŒ‡ä»¤åç§°
        validateDirectiveName(names[i])
      }
    }
    if (Component.compilerOptions && isRuntimeOnly()) {
      warn(
        `"compilerOptions" is only supported when using a build of Vue that ` +
          `includes the runtime compiler. Since you are using a runtime-only ` +
          `build, the options should be passed via your build tool config instead.`
      )
    }
  }
  // 0. create render proxy property access cache
  instance.accessCache = Object.create(null)
  // 1. create public instance / render proxy
  // also mark it raw so it's never observed
  instance.proxy = markRaw(new Proxy(instance.ctx, PublicInstanceProxyHandlers))
  if (__DEV__) {
    exposePropsOnRenderContext(instance)
  }
  // 2. call setup()
  const { setup } = Component
  if (setup) {
    const setupContext = (instance.setupContext =
      setup.length > 1 ? createSetupContext(instance) : null)

    setCurrentInstance(instance)
    pauseTracking()
    const setupResult = callWithErrorHandling(
      setup,
      instance,
      ErrorCodes.SETUP_FUNCTION,
      [__DEV__ ? shallowReadonly(instance.props) : instance.props, setupContext]
    )
    resetTracking()
    unsetCurrentInstance()

    if (isPromise(setupResult)) {
      setupResult.then(unsetCurrentInstance, unsetCurrentInstance)

      if (isSSR) {
        // return the promise so server-renderer can wait on it
        return setupResult
          .then((resolvedResult: unknown) => {
            handleSetupResult(instance, resolvedResult, isSSR)
          })
          .catch(e => {
            handleError(e, instance, ErrorCodes.SETUP_FUNCTION)
          })
      } else if (__FEATURE_SUSPENSE__) {
        // async setup returned Promise.
        // bail here and wait for re-entry.
        instance.asyncDep = setupResult
      } else if (__DEV__) {
        warn(
          `setup() returned a Promise, but the version of Vue you are using ` +
            `does not support it yet.`
        )
      }
    } else {
      handleSetupResult(instance, setupResult, isSSR)
    }
  } else {
    finishComponentSetup(instance, isSSR)
  }
}
```

æˆ‘ä»¬å¯ä»¥åœ¨ç»„ä»¶ä¸­ä½¿ç”¨activated deactivatedè¿™ä¸¤ä¸ªé’©å­å»è¿›è¡Œç›‘å¬changeã€‚

[LRU ç¼“å­˜-keep-alive å®ç°åŸç†](https://mp.weixin.qq.com/s/UBrZWeWfCBedUvDBijtqyA?st=BC021F23A550605A63766F167C7D4F0D159F5C3750606D859D7A971568E49A7967F6944AC37382B33A60F82633C9926535E6129BB9F659FF8886BC9E9BB4B71B607A2C5B8132034D2F828E38BC08862AD4881887A58C6B592BA8B4B607245B0BA7840293BB8CA9A32E5FE8335361A3FDA800D2FF24E9C4455189932383B8A65063A8B48F19614E9AE26FFD182DAE9487F9FE94590E494F28197567525E7E51C5135178C52072E15BBC683751A352995FE79E1B3BB29455A6855624434AB5F185348C1868AFCA2A857777122789B02C27E95288E1BFDD9B366295505A16A51812&vid=1688850528071330&cst=10BD599974DB523471ECB359138E29B2015E823E871793C2055A36103A9E64395F5C63732C6F32F2B174C86AFEADAACD&deviceid=075a4d46-8de9-4f1d-b4b4-b4a9e326aa9e&version=3.1.18.90318&platform=mac)