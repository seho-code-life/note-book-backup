# setup helpers

è¿™ä¸€ç« æˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹runtimecoreä¸­çš„definePropså’ŒdefineEmitsï¼ŒdefineExpose...ä¸€äº›å‡½æ•°å®ç°

ä½ å¯ä»¥ç®€å•çš„äº†è§£ä¸€ä¸‹è¿™å‡ ä¸ªapiçš„ç”¨é€”:

[å•æ–‡ä»¶ç»„ä»¶ | Vue.js](https://v3.cn.vuejs.org/api/sfc-script-setup.html#defineprops-%E5%92%8C-defineemits)

å¯ä»¥çœ‹åˆ°æ¯”å¦‚definePropsåœ¨jsä¸­ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œç›¸åº”çš„å¦‚æœæ˜¯tsï¼Œæˆ‘ä»¬ä¸ç”¨ä¼ é€’ä¸€ä¸ªå¯¹è±¡ï¼Œç›´æ¥ä¼ å…¥ä¸€ä¸ªæ³›å‹å°±æœ‰ç±»å‹æç¤ºï¼Œè€Œä¸”å®ƒä»¬éƒ½æœ‰ä¸åŒçš„é‡è½½ï¼Œå¯ä»¥ä¼ é€’æ•°ç»„ï¼Œä¹Ÿå¯ä»¥ä¼ é€’å¯¹è±¡ã€‚

è¿™ä¸€ç±»çš„apiï¼Œåªæ˜¯ä¸€ä¸ªç¼–è¯‘å¸®åŠ©ç¨‹åºï¼Œå¸®åŠ©ä½ èƒ½å¤Ÿå†™å‡ºä¸¥æ ¼çš„ä»£ç ã€‚

```tsx
// runtime-core/apiSetupHelpers.ts

// å­—ç¬¦ä¸²æ•°ç»„
export function defineProps<PropNames extends string = string>(
  props: PropNames[]
): Readonly<{ [key in PropNames]?: any }>
// å¯ä»¥ä¼ é€’ä¸€ä¸ªç¬¦åˆé¢„æœŸçš„å¯¹è±¡
export function defineProps<
  PP extends ComponentObjectPropsOptions = ComponentObjectPropsOptions
>(props: PP): Readonly<ExtractPropTypes<PP>>
// ç›´æ¥ä¼ å…¥è‡ªå®šä¹‰æ³›å‹
export function defineProps<TypeProps>(): Readonly<TypeProps>
```

definePropså…·ä½“çš„å®ç°

```tsx
export function defineProps() {
  if (__DEV__) {
		// è¿™ä»…ä»…æ˜¯ä¸€å¥æ‰“å°ï¼ŒæŒ‡çš„æ˜¯è¿™æ ·çš„apiåªæ˜¯å¸®åŠ©ç¨‹åºåšç±»å‹æç¤ºï¼Œå¹¶æ²¡æœ‰å®é™…çš„æ„ä¹‰
    warnRuntimeUsage(`defineProps`)
  }
  return null as any
}
```

å®ƒè¿”å›äº†ä¸€ä¸ªæ²¡æœ‰æ„ä¹‰çš„å€¼

æˆ‘ä»¬å¯ä»¥ç»§ç»­çœ‹apiSetupHelpersä¸­è¿˜æœ‰å…¶ä»–å‡ ä¸ªå€¼å¾—æˆ‘ä»¬æ³¨æ„çš„å‡½æ•°ï¼š

1. mergeDefaults
2. createPropsRestProxy
3. withAsyncContext

mergeDefaultså¯ä»¥å¸®åŠ©æˆ‘ä»¬åˆå¹¶é»˜è®¤å€¼ï¼Œæ¯”å¦‚è¿™æ ·:

```tsx
const merged = mergeDefaults(
  {
    foo: null,
    bar: { type: String, required: false },
    baz: String
  },
  {
    foo: 1,
    bar: 'baz',
    baz: 'qux'
  }
)
expect(merged).toMatchObject({
  foo: { default: 1 },
  bar: { type: String, required: false, default: 'baz' },
  baz: { type: String, default: 'qux' }
})
```

createPropsRestProxyå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç»™éƒ¨åˆ†propsåˆ›å»ºä¸€ä¸ªproxyå¯¹è±¡

> å€¼å¾—æ³¨æ„æ˜¯ï¼Œåœ¨è¿™ä¸ªå†…éƒ¨æ–¹æ³•ä¸­å“åº”å¼æ˜¯ç”¨defineProperty
> 

```tsx
const original = shallowReactive({
  foo: 1,
  bar: 2,
  baz: 3
})
// bazæ²¡æœ‰å“åº”å¼
const rest = createPropsRestProxy(original, ['foo', 'bar'])
expect('foo' in rest).toBe(false)
expect('bar' in rest).toBe(false)
expect(rest.baz).toBe(3)
expect(Object.keys(rest)).toEqual(['baz'])

original.baz = 4
// è¿™è¾¹æ ¡éªŒç»“æœåº”è¯¥æ˜¯falseï¼Œå› ä¸ºbazä¸æ˜¯å“åº”å¼
expect(rest.baz).toBe(4)
```

withAsyncContextå°±å‰å®³äº†ï¼Œsfcçš„setupæ–°ç‰¹æ€§é¡¶å±‚asyncå°±æ˜¯ç”±è¿™ä¸ªå¸®åŠ©ç¨‹åºwithAsyncContexté…åˆ*compiler-sfc*åšåˆ°çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªå¸®åŠ©ç¨‹åºçš„æ³¨é‡Šçœ‹åˆ°ï¼Œç¼–è¯‘å‰å’Œç¼–è¯‘åçš„åŒºåˆ«ï¼Œæš‚æ—¶é¢„ä¹ ä¸€ä¸‹ğŸ˜„

```tsx
// æ¯”å¦‚æˆ‘ä»¬åœ¨sfcä¸­ï¼Œscripté¡¶å±‚å†™äº†è¿™æ ·ä¸€æ®µä»£ç 
<script lang="ts" setup>
const x = await foo()
</script>

// å…¶ä¸­çš„å†…å®¹å°±ä¼šè¢«ç¼–è¯‘ä¸º
let __temp, __restore
const x = (([__temp, __restore] = withAsyncContext(() => foo())),__temp=await __temp,__restore(),__temp)
```

ç°åœ¨æˆ‘ä»¬å°±ä¸€ä¸€è§£é‡Šè¿™å‡ ä¸ªapiå»å¾€å“ªé‡Œï¼Œå› ä¸ºhelpersé‡Œé¢åŸºæœ¬æ‰€æœ‰çš„å†…å®¹éƒ½å¯¹å¤–å¯¼å‡ºäº†ï¼Œåœ¨runtimecoreä¸­index.tsè¿™æ ·å®ç°

```tsx
export {
  // ç¼–è¯‘å™¨å® è¿è¡Œsetupæ—¶æ‰ä¼šè¢«ç¼–è¯‘, ä»…ä¸ºäº†æ£€æŸ¥å’Œç±»å‹
  defineProps,
  defineEmits,
  defineExpose,
  withDefaults,
  // å†…éƒ¨çš„æ–¹æ³•ï¼Œå°±æ˜¯åˆšåˆšæˆ‘ä»¬è¯´çš„è¿™ä¸‰ä¸ªæ–¹æ³•
  mergeDefaults,
  createPropsRestProxy,
  withAsyncContext
} from './apiSetupHelpers'
```

æˆ‘ä»¬å¯ä»¥åœ¨compiler-sfcï¼ˆç¼–è¯‘vueå•æ–‡ä»¶ç»„ä»¶ï¼‰è¿™ä¸ªåŒ…é‡Œé¢æ‰¾åˆ°ç›¸å…³æ–‡ä»¶compileScriptï¼Œé¡¾åæ€ä¹‰å®ƒæ˜¯ä¸“é—¨ç¼–è¯‘scriptçš„ï¼Œä½†æ˜¯compilerä¸æ˜¯æœ¬ç« çš„é‡ç‚¹ï¼Œç”šè‡³æˆ‘ä»¬çš„ç¬”è®°å¯èƒ½éƒ½ä¸ä¼šå»è®²ç¼–è¯‘å™¨ã€‚æ‰€ä»¥æˆ‘ä»¬åªæè¿°æ‘˜è¦éƒ¨åˆ†ï¼Œè®©å¤§å®¶ç†è§£è¿™å‡ ä¸ªå‡½æ•°å…·ä½“åšäº†ä»€ä¹ˆã€‚

```tsx
// compiler-sfc/compileScript.ts
const helperImports: Set<string> = new Set()

function helper(key: string): string {
  helperImports.add(key)
  return `_${key}`
}

// å¤§å®¶åªéœ€è¦çŸ¥é“helperImportsæœ€ç»ˆè¢«ç”¨åœ¨è¿™é‡Œï¼Œç”¨æ¥ç”Ÿæˆå¯¼å…¥ä¾èµ–
// `import { ${[...helperImports]
        //.map(h => `${h} as _${h}`)
        //.join(', ')} } from 'vue'\n`
```

æ‰€ä»¥åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼ŒhelperImportsç»å¸¸ä¼šè¢«addï¼Œè€Œæˆ‘ä»¬å¯¼å‡ºçš„å‡ ä¸ªå‡½æ•°ä¹Ÿä¼šè¢«ä½¿ç”¨åˆ°ã€‚
ç°åœ¨æˆ‘ä»¬æ¥ä¾æ¬¡çœ‹çœ‹æ¯ä¸ªå‡½æ•°

```tsx
// mergeDefaults
// è¿™ä¸ªå‡½æ•°å°±æ˜¯è°ƒç”¨mergeDefaultsï¼Œè°ƒç”¨çš„è¿”å›ç»“æœä¼šä½œä¸ºä¸€ä¸ªå¯¹è±¡è¿”å›
if (propsRuntimeDefaults && !hasStaticDefaults) {
  propsDecls = `${helper('mergeDefaults')}(${propsDecls}, ${source.slice(
    propsRuntimeDefaults.start! + startOffset,
    propsRuntimeDefaults.end! + startOffset
  )})`
}

return `\n  props: ${propsDecls},`
```

```tsx
// createPropsRestProxy
// åŒæ ·è¢«ç¼–è¯‘æˆæˆ‘ä»¬ä¸Šé¢æµ‹è¯•ç”¨ä¾‹çš„æ ·å­äº†
s.prependLeft(
    startOffset,
    `\nconst ${propsDestructureRestId} = ${helper(
      `createPropsRestProxy`
    )}(__props, ${JSON.stringify(Object.keys(propsDestructuredBindings))})\n`
  )
```

```tsx
// withAsyncContext
s.overwrite(
    node.start! + startOffset,
    argumentStart + startOffset,
    `${needSemi ? `;` : ``}(\n  ([__temp,__restore] = ${helper(
      `withAsyncContext`
    )}(${containsNestedAwait ? `async ` : ``}() => `
  )

// å’Œæµ‹è¯•ç”¨ä¾‹ä¸€æ ·ï¼Œä¼šè¢«ç¼–è¯‘æˆä¸‹é¢è¿™ä¸ªæ ·å­
/**
   * await foo()
   * -->
   * ;(
   *   ([__temp,__restore] = withAsyncContext(() => foo())),
   *   await __temp,
   *   __restore()
   * )
   *
   * const a = await foo()
   * -->
   * const a = (
   *   ([__temp, __restore] = withAsyncContext(() => foo())),
   *   __temp = await __temp,
   *   __restore(),
   *   __temp
   * )
   */
```

ç¼–è¯‘å™¨çš„å†…å®¹å¤ªå¤šäº†ï¼Œè¯¸å¦‚definePropsè¿™ä¸€éƒ¨åˆ†apiï¼Œæˆ‘å†åˆ—ä¸¾ä¸€ä¸ªå§

```tsx
// æˆ‘ä»¬ä½¿ç”¨definePropså’ŒdefineEmitsè¿™ä¸€ç±»ï¼Œè™½ç„¶åœ¨setupä¸ç”¨è¢«å¯¼å…¥ï¼Œä½†æ˜¯åœ¨ç¼–è¯‘sfcçš„æ—¶å€™ï¼Œä¼šè¢«ç¼–è¯‘æˆä¸‹é¢è¿™ä¸ªæ ·å­

export default {
  props: {
    foo: String
  },
  emits: ['change', 'delete'],
  setup(props, { emit }) {
    // setup code
  }
}
```

ç»“æŸï¼Œæœ¬ç¯‡å†…å®¹å¤§ç¯‡å¹…çš„å†è®²ç¼–è¯‘å™¨ç›¸å…³çš„ä»£ç ï¼Œå’Œæˆ‘ä»¬åˆ†æçš„runtimecoreç›¸èƒŒï¼Œä½†æ˜¯ä¸ç”¨æ‹…å¿ƒï¼Œå°½ç®¡è¿™ä¸€ç« æœ‰å¾ˆå¤šé™Œç”Ÿçš„ä»£ç ï¼Œä½†æ˜¯ä¸æ¯«ä¸ä¼šå½±å“è¿™å‡ ä¸ªå‡½æ•°çš„å®šä¹‰ã€‚å› ä¸ºåœ¨è¿™ä¸€ç« æˆ‘ä»¬çš„ç›®æ ‡ä»…ä»…æ˜¯ææ¸…æ¥šè¿™å‡ ä¸ªhelpersæ˜¯ä»€ä¹ˆï¼Œè¿˜æœ‰å°±æ˜¯äº†è§£ç¼–è¯‘sfcçš„ä¸€äº›é»‘é­”æ³•ï¼ŒåŸæ¥è¿™äº›è®©æˆ‘ä»¬å¼€å‘è€…è§‰å¾—å¾ˆç¹ççš„ä»£ç éƒ½è¢«ç¼–è¯‘å™¨æ›¿ä»£äº†ã€‚

æ€»ç»“ï¼š

1. è¿™ä¸€ç¯‡æˆ‘ä»¬è®²è¿°äº†definePropsï¼ŒdefineEmitsç­‰å‡ ä¸ªapiï¼Œå®ƒä»¬æ˜¯ç¼–è¯‘å™¨å®ï¼Œä¸éœ€è¦å¼•å…¥ï¼Œä»…ä»…ä¸ºå¼€å‘æä¾›ç±»å‹æç¤ºï¼Œä½†æ˜¯è¢«ç¼–è¯‘å™¨ç¼–è¯‘åï¼Œä¼šç”Ÿæˆæˆ‘ä»¬ç†Ÿæ‚‰options apiã€‚
2. æˆ‘ä»¬è¿˜è®¤è¯†äº†å‡ ä¸ªå†…éƒ¨æ–¹æ³•ï¼Œè¿™äº›å†…éƒ¨æ–¹æ³•éƒ½æ˜¯å¸®åŠ©ç¼–è¯‘å™¨åšå¤„ç†çš„ã€‚

å‚è€ƒ

[rfcs/0040-script-setup.md at master Â· vuejs/rfcs](https://github.com/vuejs/rfcs/blob/master/active-rfcs/0040-script-setup.md)